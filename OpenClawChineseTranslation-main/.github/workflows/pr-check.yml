# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - PR æ£€æŸ¥å·¥ä½œæµ
# æ­¦æ±‰æ™´è¾°å¤©ä¸‹ç½‘ç»œç§‘æŠ€æœ‰é™å…¬å¸ | https://qingchencloud.com/
# ============================================================
#
# è§¦å‘æ–¹å¼ï¼š
#   - PR æäº¤åˆ° main åˆ†æ”¯æ—¶
#   - æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽè°ƒè¯•ï¼‰
#
# æ£€æŸ¥å†…å®¹ï¼š
#   - JSON æ ¼å¼éªŒè¯
#   - ç¿»è¯‘è§„åˆ™éªŒè¯
#   - é¢æ¿æ•°æ®éªŒè¯
#   - Python è„šæœ¬è¯­æ³•æ£€æŸ¥
# ============================================================

name: PR æ£€æŸ¥

on:
  pull_request:
    branches: [main]
    paths:
      - 'translations/**'
      - 'cli/**'
      - 'scripts/**'
      - '*.sh'
      - '*.ps1'
  workflow_dispatch:

jobs:
  # ==================== ç¿»è¯‘è§„åˆ™éªŒè¯ ====================
  validate-translations:
    name: éªŒè¯ç¿»è¯‘è§„åˆ™
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: éªŒè¯ JSON æ ¼å¼
        run: |
          echo "ðŸ” æ£€æŸ¥æ‰€æœ‰ç¿»è¯‘ JSON æ–‡ä»¶æ ¼å¼..."
          ERROR_COUNT=0
          
          for file in $(find translations -name "*.json"); do
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ JSON æ ¼å¼é”™è¯¯: $file"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ å‘çŽ° $ERROR_COUNT ä¸ª JSON æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ JSON æ–‡ä»¶æ ¼å¼æ­£ç¡®"

      - name: éªŒè¯ç¿»è¯‘é…ç½®
        run: |
          echo "ðŸ” æ£€æŸ¥ç¿»è¯‘é…ç½®æ–‡ä»¶..."
          
          # æ£€æŸ¥ config.json å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
          if [ ! -f "translations/config.json" ]; then
            echo "âŒ ç¼ºå°‘ translations/config.json"
            exit 1
          fi
          
          # éªŒè¯é…ç½®ç»“æž„
          jq -e '.modules' translations/config.json > /dev/null || {
            echo "âŒ config.json ç¼ºå°‘ modules å­—æ®µ"
            exit 1
          }
          
          echo "âœ… ç¿»è¯‘é…ç½®éªŒè¯é€šè¿‡"

      - name: æ£€æŸ¥ç¿»è¯‘è§„åˆ™çŠ¶æ€
        run: |
          echo "ðŸ” æ£€æŸ¥ç¿»è¯‘è§„åˆ™çŠ¶æ€..."
          node cli/index.mjs status || true
          echo "âœ… ç¿»è¯‘è§„åˆ™çŠ¶æ€æ£€æŸ¥å®Œæˆ"

      - name: éªŒè¯é¢æ¿æ•°æ®
        run: |
          echo "ðŸ” æ£€æŸ¥é¢æ¿æ•°æ®..."
          
          PANEL_DATA="translations/panel/panel-data.json"
          
          if [ ! -f "$PANEL_DATA" ]; then
            echo "âš ï¸ é¢æ¿æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥"
            exit 0
          fi
          
          # éªŒè¯ JSON æ ¼å¼
          jq empty "$PANEL_DATA" || {
            echo "âŒ panel-data.json æ ¼å¼é”™è¯¯"
            exit 1
          }
          
          # éªŒè¯å¿…éœ€å­—æ®µ
          jq -e '.faq' "$PANEL_DATA" > /dev/null || {
            echo "âŒ panel-data.json ç¼ºå°‘ faq å­—æ®µ"
            exit 1
          }
          
          jq -e '.plugins' "$PANEL_DATA" > /dev/null || {
            echo "âŒ panel-data.json ç¼ºå°‘ plugins å­—æ®µ"
            exit 1
          }
          
          jq -e '.about' "$PANEL_DATA" > /dev/null || {
            echo "âŒ panel-data.json ç¼ºå°‘ about å­—æ®µ"
            exit 1
          }
          
          echo "âœ… é¢æ¿æ•°æ®éªŒè¯é€šè¿‡"

  # ==================== Python è„šæœ¬æ£€æŸ¥ ====================
  validate-scripts:
    name: éªŒè¯ Python è„šæœ¬
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pyflakes

      - name: æ£€æŸ¥ Python è¯­æ³•
        run: |
          echo "ðŸ” æ£€æŸ¥ Python è„šæœ¬è¯­æ³•..."
          ERROR_COUNT=0
          
          for file in scripts/*.py; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥: $file"
              if ! python3 -m py_compile "$file"; then
                echo "âŒ è¯­æ³•é”™è¯¯: $file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              fi
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ å‘çŽ° $ERROR_COUNT ä¸ª Python è¯­æ³•é”™è¯¯"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰ Python è„šæœ¬è¯­æ³•æ­£ç¡®"

      - name: è¿è¡Œ pyflakes æ£€æŸ¥
        run: |
          echo "ðŸ” è¿è¡Œ pyflakes é™æ€æ£€æŸ¥..."
          pyflakes scripts/*.py || true
          echo "âœ… pyflakes æ£€æŸ¥å®Œæˆ"

  # ==================== Shell è„šæœ¬æ£€æŸ¥ ====================
  validate-shell:
    name: éªŒè¯ Shell è„šæœ¬
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: æ£€æŸ¥ Bash è„šæœ¬è¯­æ³•
        run: |
          echo "ðŸ” æ£€æŸ¥ Bash è„šæœ¬è¯­æ³•..."
          
          for file in *.sh; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥: $file"
              bash -n "$file" || {
                echo "âŒ è¯­æ³•é”™è¯¯: $file"
                exit 1
              }
            fi
          done
          
          echo "âœ… æ‰€æœ‰ Bash è„šæœ¬è¯­æ³•æ­£ç¡®"

      - name: è¿è¡Œ ShellCheck
        run: |
          echo "ðŸ” è¿è¡Œ ShellCheck..."
          shellcheck *.sh || true
          echo "âœ… ShellCheck æ£€æŸ¥å®Œæˆ"

  # ==================== æ£€æŸ¥æ‘˜è¦ ====================
  summary:
    name: æ£€æŸ¥æ‘˜è¦
    needs: [validate-translations, validate-scripts, validate-shell]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ç”Ÿæˆæ‘˜è¦
        run: |
          echo "## ðŸ” PR æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-translations.result }}" == "success" ]; then
            echo "| ç¿»è¯‘è§„åˆ™éªŒè¯ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ç¿»è¯‘è§„åˆ™éªŒè¯ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-scripts.result }}" == "success" ]; then
            echo "| Python è„šæœ¬æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python è„šæœ¬æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-shell.result }}" == "success" ]; then
            echo "| Shell è„šæœ¬æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Shell è„šæœ¬æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
