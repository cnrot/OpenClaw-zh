# ============================================================
# OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - ç¨³å®šç‰ˆè‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ
# ============================================================
#
# è§¦å‘æ–¹å¼ï¼š
#   1. å®šæ—¶ä»»åŠ¡ (æ¯å°æ—¶): è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ openclaw/openclaw çš„æœ€æ–° releaseã€‚
#   2. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch): ç”¨äºŽç´§æ€¥å‘å¸ƒæˆ–é‡æ–°æž„å»ºã€‚
#
# ç‰ˆæœ¬è¯´æ˜Žï¼š
#   - ç¨³å®šç‰ˆ (@latest)ï¼šæœ¬å·¥ä½œæµå‘å¸ƒï¼Œè‡ªåŠ¨è·Ÿéšä¸Šæ¸¸ç¨³å®šç‰ˆã€‚
#   - æœ€æ–°ç‰ˆ (@nightly)ï¼šnightly.yml å‘å¸ƒï¼Œæ¯ 4 å°æ—¶è‡ªåŠ¨æž„å»º
#
# ä¼˜åŒ–ï¼š
#   - è°ƒç”¨ build-core.yml å¤ç”¨å·¥ä½œæµï¼Œå‡å°‘ä»£ç é‡å¤
# ============================================================

name: ç¨³å®šç‰ˆå‘å¸ƒ (è‡ªåŠ¨)

on:
  schedule:
    # æ¯å°æ—¶çš„ç¬¬ 15 åˆ†é’Ÿè¿è¡Œï¼Œæ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    - cron: '15 * * * *'
  workflow_dispatch: {}

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

permissions:
  contents: write
  packages: write

jobs:
  # ==================== æ£€æŸ¥ä¸Šæ¸¸ç‰ˆæœ¬ ====================
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      upstream_tag: ${{ steps.check.outputs.upstream_tag }}
    steps:
      - name: èŽ·å–ä¸Šæ¸¸æœ€æ–° Release Tag
        id: get_upstream_tag
        run: |
          LATEST_UPSTREAM_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest" | jq -r .tag_name)
          
          if [ -z "$LATEST_UPSTREAM_TAG" ] || [ "$LATEST_UPSTREAM_TAG" == "null" ]; then
            echo "::error::æ— æ³•èŽ·å–ä¸Šæ¸¸ Release Tag"
            exit 1
          fi
          
          echo "upstream_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ”Ž ä¸Šæ¸¸æœ€æ–° Tag: $LATEST_UPSTREAM_TAG"

      - name: èŽ·å–æˆ‘ä»¬æœ€æ–°çš„ Release Tag
        id: get_our_tag
        run: |
          OUR_LATEST_TAG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r .tag_name)
          echo "our_latest_tag=${OUR_LATEST_TAG:-'v0.0.0-zh.0'}" >> $GITHUB_OUTPUT
          echo "ðŸ”Ž æˆ‘ä»¬æœ€æ–° Tag: ${OUR_LATEST_TAG:-'v0.0.0-zh.0'}"

      - name: æ¯”è¾ƒç‰ˆæœ¬ä»¥ç¡®å®šæ˜¯å¦ç»§ç»­
        id: check
        run: |
          # ä»Žæˆ‘ä»¬çš„ tag ä¸­æå–åŸºç¡€ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ v0.25.1-zh.1 -> v0.25.1
          OUR_BASE_TAG=$(echo "${{ steps.get_our_tag.outputs.our_latest_tag }}" | sed -E 's/(-zh\.[0-9]+)$//')
          
          echo "   æˆ‘ä»¬å¤„ç†è¿‡çš„ä¸Šæ¸¸ç‰ˆæœ¬: $OUR_BASE_TAG"
          echo "   ä¸Šæ¸¸æœ€æ–°ç¨³å®šç‰ˆ: ${{ steps.get_upstream_tag.outputs.upstream_tag }}"

          if [ "${{ steps.get_upstream_tag.outputs.upstream_tag }}" != "$OUR_BASE_TAG" ]; then
            echo "âœ… æ–°çš„ä¸Šæ¸¸ç‰ˆæœ¬å·²å‘å¸ƒï¼Œå¼€å§‹æž„å»ºæµç¨‹ï¼"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "upstream_tag=${{ steps.get_upstream_tag.outputs.upstream_tag }}" >> $GITHUB_OUTPUT
          else
            echo "â˜‘ï¸ æ— æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡æœ¬æ¬¡æž„å»ºã€‚"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # ==================== å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯ ====================
  prepare:
    needs: check-upstream
    if: needs.check-upstream.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.version.outputs.release_version }}
      upstream_version_tag: ${{ needs.check-upstream.outputs.upstream_tag }}

    steps:
      - name: ç”Ÿæˆæ–°çš„æ±‰åŒ–ç‰ˆç‰ˆæœ¬å·
        id: version
        run: |
          # ä¸Šæ¸¸ tag æ ¼å¼ä¸º 'v0.25.1'
          UPSTREAM_TAG="${{ needs.check-upstream.outputs.upstream_tag }}"
          # åŽ»æŽ‰ 'v' å‰ç¼€
          UPSTREAM_VERSION_NUM="${UPSTREAM_TAG#v}"
          # æˆ‘ä»¬çš„ç‰ˆæœ¬å·æ ¼å¼ä¸º '0.25.1-zh.1'
          OUR_NEW_VERSION="${UPSTREAM_VERSION_NUM}-zh.1"
          
          echo "release_version=$OUR_NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç”Ÿæˆæ–°ç‰ˆæœ¬å·: $OUR_NEW_VERSION"

  # ==================== è°ƒç”¨æ ¸å¿ƒæž„å»º ====================
  build:
    needs: [check-upstream, prepare]
    if: needs.check-upstream.outputs.should_run == 'true'
    uses: ./.github/workflows/build-core.yml
    with:
      version_type: stable
      version: ${{ needs.prepare.outputs.release_version }}
      upstream_version: ${{ needs.prepare.outputs.upstream_version_tag }} # ä½¿ç”¨ tag ä½œä¸ºç‰ˆæœ¬ä¿¡æ¯
      upstream_version_tag: ${{ needs.prepare.outputs.upstream_version_tag }}
    secrets: inherit

  # ==================== å‘å¸ƒåˆ° npm å’Œ Docker ====================
  publish:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: openclaw-build-stable
          path: openclaw

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: å®‰è£…ä¾èµ–
        working-directory: openclaw
        run: pnpm install --frozen-lockfile

      - name: å‘å¸ƒåˆ° npm (@latest)
        working-directory: openclaw
        # ä½¿ç”¨ --ignore-scripts è·³è¿‡ prepack è„šæœ¬ï¼Œå› ä¸ºä»£ç å·²åœ¨ build job ä¸­æž„å»ºå®Œæˆ
        # å¦åˆ™ prepack ä¼šè§¦å‘é‡æ–°æž„å»ºï¼Œè¦†ç›–æŽ‰æ³¨å…¥çš„åŠŸèƒ½é¢æ¿
        run: npm publish --access public --tag latest --ignore-scripts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: åŒæ­¥ npmmirror é•œåƒæº
        run: |
          echo "ðŸ”„ è§¦å‘ npmmirror åŒæ­¥..."
          # ä¸»åŠ¨è§¦å‘ npmmirror åŒæ­¥ï¼Œè§£å†³å›½å†…é•œåƒæºç‰ˆæœ¬æ»žåŽé—®é¢˜
          # å‚è€ƒ: https://github.com/1186258278/OpenClawChineseTranslation/issues/32
          curl -sX PUT "https://registry-direct.npmmirror.com/-/package/@coryrowe/openclaw-zh/syncs" || true
          echo "â³ ç­‰å¾… 30 ç§’è®©åŒæ­¥ç”Ÿæ•ˆ..."
          sleep 30
          # éªŒè¯åŒæ­¥ç»“æžœ
          MIRROR_VER=$(curl -s "https://registry.npmmirror.com/@coryrowe/openclaw-zh/latest" | jq -r '.version // "unknown"')
          echo "ðŸ“¦ npmmirror å½“å‰ç‰ˆæœ¬: $MIRROR_VER"
          echo "ðŸ“¦ æœ¬æ¬¡å‘å¸ƒç‰ˆæœ¬: ${{ needs.prepare.outputs.release_version }}"
          if [ "$MIRROR_VER" = "${{ needs.prepare.outputs.release_version }}" ]; then
            echo "âœ… npmmirror åŒæ­¥æˆåŠŸï¼"
          else
            echo "âš ï¸ npmmirror å°šæœªåŒæ­¥åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ"
          fi
        continue-on-error: true

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.release_version }}
          name: "ðŸ¦ž OpenClaw æ±‰åŒ–ç‰ˆ v${{ needs.prepare.outputs.release_version }}"
          body: |
            ## ðŸ¦ž OpenClaw æ±‰åŒ–å‘è¡Œç‰ˆ - ç¨³å®šç‰ˆ
            
            **ç‰ˆæœ¬**: v${{ needs.prepare.outputs.release_version }}
            **ä¸Šæ¸¸ç‰ˆæœ¬**: ${{ needs.prepare.outputs.upstream_version_tag }}
            **å‘å¸ƒç±»åž‹**: ç¨³å®šç‰ˆ (Stable) - åŒæ­¥è‡ª OpenClaw å®˜æ–¹çš„åŒå Release
            
            ---
            
            ### ðŸ“Š æ±‰åŒ–ç»Ÿè®¡
            
            | æŒ‡æ ‡ | æ•°é‡ | è¯´æ˜Ž |
            |------|------|------|
            | âœ… åº”ç”¨è§„åˆ™ | **${{ needs.build.outputs.applied }}** æ¡ | æˆåŠŸåº”ç”¨çš„ç¿»è¯‘è§„åˆ™ |
            | â­ï¸ å·²å­˜åœ¨ | ${{ needs.build.outputs.existed }} æ¡ | ç¿»è¯‘å·²å­˜åœ¨ï¼Œè·³è¿‡ |
            | âš ï¸ æœªåŒ¹é… | ${{ needs.build.outputs.failed }} æ¡ | æºç å˜æ›´å¯¼è‡´æœªåŒ¹é… |
            | ðŸ“ æ›¿æ¢æ“ä½œ | ${{ needs.build.outputs.files }} æ¬¡ | å®žé™…æ‰§è¡Œçš„æ›¿æ¢æ¬¡æ•° |
            
            ---
            
            ### ðŸ“¦ å®‰è£…æ–¹å¼
            
            **ç¨³å®šç‰ˆï¼ˆæŽ¨èï¼‰ï¼š**
            ```bash
            # åŒæ­¥ OpenClaw å®˜æ–¹ç¨³å®šç‰ˆ
            npm install -g @coryrowe/openclaw-zh@latest
            ```
            
            **æœ€æ–°ç‰ˆï¼ˆæ¯ 4 å°æ—¶æ›´æ–°ï¼‰ï¼š**
            ```bash
            npm install -g @coryrowe/openclaw-zh@nightly
            ```
            
            **ä¸€é”®å®‰è£…è„šæœ¬ï¼š**
            ```bash
            # Linux/macOS
            curl -fsSL https://raw.githubusercontent.com/cnrot/OpenClaw-zh/main/install.sh | bash
            
            # Windows PowerShell
            powershell -c "irm https://raw.githubusercontent.com/cnrot/OpenClaw-zh/main/install.ps1 | iex"
            ```
            
            ---
            
            ### ðŸ”— ç›¸å…³é“¾æŽ¥
            
            - ðŸ“– æ–‡æ¡£: https://github.com/cnrot/OpenClaw-zh
            - ðŸ“¦ npm: https://www.npmjs.com/package/@coryrowe/openclaw-zh
            - ðŸŒ™ æœ€æ–°ç‰ˆ: https://github.com/cnrot/OpenClaw-zh/releases/tag/nightly
            
            ---
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== Docker é•œåƒæž„å»ºä¸ŽæŽ¨é€ ====================
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡ Docker å…ƒæ•°æ®
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/cnrot/openclaw-zh
          tags: |
            type=raw,value=latest
            type=raw,value=${{ needs.prepare.outputs.release_version }}

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          # ä½¿ç”¨ Registry Cache - æ¯” GHA ç¼“å­˜æ›´ç¨³å®šï¼Œæ—  10GB é™åˆ¶
          cache-from: type=registry,ref=ghcr.io/cnrot/openclaw-zh:buildcache
          cache-to: type=registry,ref=ghcr.io/cnrot/openclaw-zh:buildcache,mode=max
          platforms: linux/amd64,linux/arm64

      - name: è®¾ç½®é•œåƒä¸ºå…¬å¼€
        run: |
          # ä½¿ç”¨ GitHub API å°†åŒ…è®¾ç½®ä¸ºå…¬å¼€
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/packages/container/openclaw-zh/versions \
            -d '{"visibility":"public"}' || true
          echo "âœ… Docker é•œåƒå·²æŽ¨é€åˆ° ghcr.io"

      # ==================== Docker Hub é•œåƒ ====================
      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: coryrowe
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: æŽ¨é€åˆ° Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: |
            coryrowe/openclaw-zh:latest
            coryrowe/openclaw-zh:${{ needs.prepare.outputs.release_version }}
          cache-from: type=registry,ref=ghcr.io/cnrot/openclaw-zh:buildcache
          platforms: linux/amd64,linux/arm64
        continue-on-error: true

      # åŒæ­¥ Docker Hub ä»“åº“æè¿°
      - name: æ›´æ–° Docker Hub æè¿°
        uses: peter-evans/dockerhub-description@v4
        with:
          username: coryrowe
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: coryrowe/openclaw-zh
          readme-filepath: ./DOCKER_README.md
        continue-on-error: true

      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## ðŸ¦ž ç¨³å®šç‰ˆå‘å¸ƒå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬å· | v${{ needs.prepare.outputs.release_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ä¸Šæ¸¸ç‰ˆæœ¬ | ${{ needs.prepare.outputs.upstream_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| åº”ç”¨è§„åˆ™ | ${{ needs.build.outputs.applied }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "| æœªåŒ¹é…è§„åˆ™ | ${{ needs.build.outputs.failed }} æ¡ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ å®‰è£…æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm**: \`npm install -g @coryrowe/openclaw-zh@latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker (ghcr.io)**: \`docker pull ghcr.io/cnrot/openclaw-zh:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Hub**: \`docker pull coryrowe/openclaw-zh:latest\`" >> $GITHUB_STEP_SUMMARY
